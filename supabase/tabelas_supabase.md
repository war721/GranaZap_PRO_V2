create table public.api_usage_log (
  id uuid not null default gen_random_uuid (),
  api_name text not null,
  endpoint text not null,
  tickers_count integer not null,
  status text not null,
  response_time_ms integer null,
  error_message text null,
  created_at timestamp with time zone not null default timezone ('utc'::text, now()),
  constraint api_usage_log_pkey primary key (id),
  constraint api_usage_log_status_check check (
    (
      status = any (
        array[
          'success'::text,
          'error'::text,
          'rate_limit'::text
        ]
      )
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_api_usage_log_created_at on public.api_usage_log using btree (created_at) TABLESPACE pg_default;

create index IF not exists idx_api_usage_log_api_name on public.api_usage_log using btree (api_name) TABLESPACE pg_default;

create index IF not exists idx_api_usage_log_status on public.api_usage_log using btree (status) TABLESPACE pg_default; 


, create table public.cartoes_credito (
  id uuid not null default gen_random_uuid (),
  usuario_id uuid null,
  nome text not null,
  bandeira text null,
  ultimos_digitos text null,
  limite_total numeric(10, 2) not null default 0,
  dia_fechamento integer not null,
  dia_vencimento integer not null,
  tipo_conta text not null default 'pessoal'::text,
  cor_cartao text null default '#8A05BE'::text,
  ativo boolean null default true,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  conta_vinculada_id uuid null,
  user_id integer not null,
  constraint cartoes_credito_pkey primary key (id),
  constraint cartoes_credito_conta_vinculada_id_fkey foreign KEY (conta_vinculada_id) references contas_bancarias (id) on delete set null,
  constraint cartoes_credito_usuario_id_fkey foreign KEY (usuario_id) references auth.users (id) on delete CASCADE,
  constraint fk_cartoes_user_id foreign KEY (user_id) references usuarios (id) on delete CASCADE,
  constraint cartoes_credito_tipo_conta_check check (
    (
      tipo_conta = any (array['pessoal'::text, 'pj'::text])
    )
  ),
  constraint cartoes_limite_positivo check ((limite_total >= (0)::numeric)),
  constraint cartoes_credito_dia_vencimento_check check (
    (
      (dia_vencimento >= 1)
      and (dia_vencimento <= 31)
    )
  ),
  constraint cartoes_credito_dia_fechamento_check check (
    (
      (dia_fechamento >= 1)
      and (dia_fechamento <= 31)
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_cartoes_usuario on public.cartoes_credito using btree (usuario_id) TABLESPACE pg_default;

create index IF not exists idx_cartoes_tipo_conta on public.cartoes_credito using btree (tipo_conta) TABLESPACE pg_default;

create index IF not exists idx_cartoes_ativo on public.cartoes_credito using btree (ativo) TABLESPACE pg_default;

create index IF not exists idx_cartoes_conta_vinculada on public.cartoes_credito using btree (conta_vinculada_id) TABLESPACE pg_default;

create index IF not exists idx_cartoes_user_id on public.cartoes_credito using btree (user_id) TABLESPACE pg_default;

create trigger sync_user_id_cartoes BEFORE INSERT
or
update on cartoes_credito for EACH row
execute FUNCTION sync_user_id_from_auth (); ,

create table public.categoria_trasacoes (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone null default now(),
  descricao text not null,
  usuario_id integer not null,
  icon_key text null,
  tipo text null default 'ambos'::text,
  tipo_conta text not null default 'pessoal'::text,
  keywords text[] null default '{}'::text[],
  constraint categoria_despesas_pkey primary key (id),
  constraint categoria_trasacoes_usuario_id_fkey foreign KEY (usuario_id) references usuarios (id) on delete CASCADE,
  constraint categoria_trasacoes_tipo_check check (
    (
      tipo = any (
        array['entrada'::text, 'saida'::text, 'ambos'::text]
      )
    )
  ),
  constraint categoria_trasacoes_tipo_conta_check check (
    (
      tipo_conta = any (array['pessoal'::text, 'pj'::text])
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_categoria_trasacoes_usuario_id on public.categoria_trasacoes using btree (usuario_id) TABLESPACE pg_default;

create index IF not exists idx_categorias_usuario on public.categoria_trasacoes using btree (usuario_id) TABLESPACE pg_default;

create index IF not exists idx_categorias_tipo on public.categoria_trasacoes using btree (tipo) TABLESPACE pg_default;

create index IF not exists idx_categories_tipo_conta on public.categoria_trasacoes using btree (tipo_conta) TABLESPACE pg_default;

create index IF not exists idx_categories_user_type on public.categoria_trasacoes using btree (usuario_id, tipo_conta) TABLESPACE pg_default;

create index IF not exists idx_categories_keywords on public.categoria_trasacoes using gin (keywords) TABLESPACE pg_default; 

, create table public.cdi_rates (
  id uuid not null default gen_random_uuid (),
  date date not null,
  rate numeric(10, 6) not null,
  source text null default 'banco_central'::text,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  constraint cdi_rates_pkey primary key (id),
  constraint cdi_rates_date_key unique (date)
) TABLESPACE pg_default;

create index IF not exists idx_cdi_rates_date on public.cdi_rates using btree (date desc) TABLESPACE pg_default; , 

create table public.configuracoes_sistema (
  id integer generated by default as identity not null,
  primary_color text null default '#7c4dff'::text,
  secondary_color text null default '#6a3de8'::text,
  logo_url text null default ''::text,
  company_name text null default 'GranaZap'::text,
  white_label_active boolean null default false,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  company_slogan text null default 'Gerencie suas finanças de forma simples'::text,
  logo_url_header text null default ''::text,
  logo_url_login text null default ''::text,
  show_header_logo boolean not null default true,
  show_header_name boolean not null default true,
  logo_url_header_dark text null default ''::text,
  logo_url_login_dark text null default ''::text,
  logo_url_header_light text null default ''::text,
  logo_url_login_light text null default ''::text,
  show_index_name boolean not null default true,
  favicon_url text null default ''::text,
  dias_acesso_free integer null default 7,
  bloquear_acesso_apos_vencimento boolean null default true,
  support_title text null default 'Precisa de ajuda?'::text,
  support_description text null default 'Em caso de dúvidas sobre seu plano ou problemas com o pagamento, entre em contato com nosso suporte.'::text,
  support_info_1 text null default 'Planos são renovados automaticamente'::text,
  support_info_2 text null default 'Você pode cancelar a qualquer momento'::text,
  support_info_3 text null default 'Mudanças entram em vigor imediatamente'::text,
  support_contact_url text null default ''::text,
  support_contact_text text null default 'Falar com Suporte'::text,
  whatsapp_contact_url text null default ''::text,
  whatsapp_contact_text text null default 'Falar com Suporte'::text,
  whatsapp_enabled boolean null default false,
  restringir_cadastro_usuarios_existentes boolean null default true,
  login_welcome_text text null default 'Seja Bem-vindo ao'::text,
  login_feature_1_title text null default 'Acompanhe suas despesas e receitas'::text,
  login_feature_1_subtitle text null default 'em tempo real'::text,
  login_feature_2_title text null default 'Defina metas financeiras e acompanhe'::text,
  login_feature_2_subtitle text null default 'seu progresso'::text,
  login_feature_3_title text null default 'Acesse de qualquer dispositivo, a'::text,
  login_feature_3_subtitle text null default 'qualquer momento'::text,
  login_feature_4_title text null default 'Seus dados estão sempre seguros e'::text,
  login_feature_4_subtitle text null default 'protegidos'::text,
  login_background_image_url text null default ''::text,
  login_use_background_image boolean null default false,
  login_background_image_opacity numeric(3, 2) null default 0.5,
  login_hide_logo_on_image boolean null default false,
  login_show_text_on_image boolean null default true,
  support_email character varying(255) null default 'suporte@granazap.com'::character varying,
  bloquear_cadastro_novos_usuarios boolean null default false,
  habilitar_modo_pj boolean null default true,
  show_sidebar_logo boolean null default false,
  show_sidebar_name boolean null default true,
  show_login_logo boolean null default false,
  show_login_name boolean null default true,
  logo_url_sidebar text null,
  video_url_instalacao text null,
  whatsapp_suporte_url text null,
  webhook_convite_membro text null default ''::text,
  constraint configuracoes_sistema_pkey primary key (id)
) TABLESPACE pg_default; , 

create table public.consentimentos_usuarios (
  id integer generated by default as identity not null,
  usuario_id integer not null,
  tipo_consentimento text not null,
  data_consentimento timestamp with time zone null default now(),
  status boolean null default true,
  versao_politica text not null,
  ip_origem text null,
  constraint consentimentos_usuarios_pkey primary key (id),
  constraint consentimentos_usuarios_usuario_id_fkey foreign KEY (usuario_id) references usuarios (id) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_consentimentos_usuarios_usuario_id on public.consentimentos_usuarios using btree (usuario_id) TABLESPACE pg_default; ,

create table public.contas_bancarias (
  id uuid not null default gen_random_uuid (),
  usuario_id uuid not null,
  nome text not null,
  banco text null,
  saldo_atual numeric(15, 2) not null default 0,
  is_default boolean null default false,
  is_archived boolean null default false,
  tipo_conta text not null default 'pessoal'::text,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  user_id integer not null,
  constraint contas_bancarias_pkey primary key (id),
  constraint contas_bancarias_usuario_id_fkey foreign KEY (usuario_id) references auth.users (id) on delete CASCADE,
  constraint fk_contas_user_id foreign KEY (user_id) references usuarios (id) on delete CASCADE,
  constraint contas_bancarias_tipo_conta_check check (
    (
      tipo_conta = any (array['pessoal'::text, 'pj'::text])
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_contas_bancarias_usuario_id on public.contas_bancarias using btree (usuario_id) TABLESPACE pg_default;

create index IF not exists idx_contas_tipo_conta on public.contas_bancarias using btree (tipo_conta) TABLESPACE pg_default;

create index IF not exists idx_contas_bancarias_usuario_saldo on public.contas_bancarias using btree (usuario_id, saldo_atual) TABLESPACE pg_default;

create index IF not exists idx_contas_user_id on public.contas_bancarias using btree (user_id) TABLESPACE pg_default;

create trigger on_update_contas_bancarias BEFORE
update on contas_bancarias for EACH row
execute FUNCTION handle_updated_at ();

create trigger sync_user_id_contas BEFORE INSERT
or
update on contas_bancarias for EACH row
execute FUNCTION sync_user_id_from_auth ();

create trigger trigger_update_contas_bancarias_timestamp BEFORE
update on contas_bancarias for EACH row
execute FUNCTION update_contas_bancarias_updated_at (); ,

create table public.investment_assets (
  id uuid not null default gen_random_uuid (),
  ticker text not null,
  name text null,
  type text not null,
  current_price numeric(15, 2) null,
  previous_close numeric(15, 2) null,
  last_updated timestamp with time zone null,
  source text null default 'brapi'::text,
  is_active boolean null default true,
  created_at timestamp with time zone not null default timezone ('utc'::text, now()),
  updated_at timestamp with time zone not null default timezone ('utc'::text, now()),
  constraint investment_assets_pkey primary key (id),
  constraint investment_assets_ticker_key unique (ticker),
  constraint investment_assets_source_check check (
    (
      source = any (
        array[
          'brapi'::text,
          'manual'::text,
          'fallback'::text,
          'binance'::text
        ]
      )
    )
  ),
  constraint investment_assets_type_check check (
    (
      type = any (
        array[
          'acao'::text,
          'fii'::text,
          'etf'::text,
          'renda_fixa'::text,
          'cripto'::text,
          'bdr'::text
        ]
      )
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_investment_assets_ticker on public.investment_assets using btree (ticker) TABLESPACE pg_default;

create index IF not exists idx_investment_assets_type on public.investment_assets using btree (type) TABLESPACE pg_default;

create index IF not exists idx_investment_assets_source on public.investment_assets using btree (source) TABLESPACE pg_default;

create index IF not exists idx_investment_assets_active on public.investment_assets using btree (is_active) TABLESPACE pg_default;

create trigger on_update_investment_assets BEFORE
update on investment_assets for EACH row
execute FUNCTION handle_updated_at (); ,

create table public.investment_dividends (
  id uuid not null default gen_random_uuid (),
  position_id uuid not null,
  tipo text not null,
  valor_por_ativo numeric(15, 4) not null,
  data_com date null,
  data_pagamento date not null,
  observacao text null,
  created_at timestamp with time zone not null default timezone ('utc'::text, now()),
  constraint investment_dividends_pkey primary key (id),
  constraint investment_dividends_position_id_fkey foreign KEY (position_id) references investment_positions (id) on delete CASCADE,
  constraint investment_dividends_tipo_check check (
    (
      tipo = any (
        array[
          'dividendo'::text,
          'jcp'::text,
          'rendimento'::text,
          'amortizacao'::text
        ]
      )
    )
  ),
  constraint investment_dividends_valor_por_ativo_check check ((valor_por_ativo > (0)::numeric))
) TABLESPACE pg_default;

create index IF not exists idx_investment_dividends_position on public.investment_dividends using btree (position_id) TABLESPACE pg_default;

create index IF not exists idx_investment_dividends_data_pagamento on public.investment_dividends using btree (data_pagamento) TABLESPACE pg_default; ,

create table public.investment_positions (
  id uuid not null default gen_random_uuid (),
  usuario_id uuid not null,
  asset_id uuid not null,
  conta_id uuid null,
  quantidade numeric(15, 4) not null,
  preco_medio numeric(15, 2) not null,
  data_compra date not null,
  tipo_conta text not null,
  is_manual_price boolean null default false,
  manual_price numeric(15, 8) null,
  observacao text null,
  created_at timestamp with time zone not null default timezone ('utc'::text, now()),
  updated_at timestamp with time zone not null default timezone ('utc'::text, now()),
  yield_percentage numeric(5, 2) null default null::numeric,
  manual_ir numeric(15, 2) null,
  manual_iof numeric(15, 2) null,
  use_manual_tax boolean null default false,
  user_id integer not null,
  constraint investment_positions_pkey primary key (id),
  constraint investment_positions_usuario_id_asset_id_key unique (usuario_id, asset_id),
  constraint investment_positions_conta_id_fkey foreign KEY (conta_id) references contas_bancarias (id) on delete set null,
  constraint fk_investments_user_id foreign KEY (user_id) references usuarios (id) on delete CASCADE,
  constraint investment_positions_asset_id_fkey foreign KEY (asset_id) references investment_assets (id) on delete RESTRICT,
  constraint investment_positions_usuario_id_fkey foreign KEY (usuario_id) references auth.users (id) on delete CASCADE,
  constraint investment_positions_tipo_conta_check check (
    (
      tipo_conta = any (array['pessoal'::text, 'pj'::text])
    )
  ),
  constraint investment_positions_preco_medio_check check ((preco_medio >= (0)::numeric)),
  constraint investment_positions_quantidade_check check ((quantidade > (0)::numeric))
) TABLESPACE pg_default;

create index IF not exists idx_investment_positions_usuario on public.investment_positions using btree (usuario_id) TABLESPACE pg_default;

create index IF not exists idx_investment_positions_asset on public.investment_positions using btree (asset_id) TABLESPACE pg_default;

create index IF not exists idx_investment_positions_conta on public.investment_positions using btree (conta_id) TABLESPACE pg_default;

create index IF not exists idx_investment_positions_tipo_conta on public.investment_positions using btree (tipo_conta) TABLESPACE pg_default;

create index IF not exists idx_investment_positions_yield on public.investment_positions using btree (yield_percentage) TABLESPACE pg_default
where
  (yield_percentage is not null);

create index IF not exists idx_investments_user_id on public.investment_positions using btree (user_id) TABLESPACE pg_default;

create trigger on_update_investment_positions BEFORE
update on investment_positions for EACH row
execute FUNCTION handle_updated_at ();

create trigger sync_user_id_investments BEFORE INSERT
or
update on investment_positions for EACH row
execute FUNCTION sync_user_id_from_auth (); 

create table public.lancamentos_futuros (
  id integer generated by default as identity not null,
  created_at timestamp without time zone null default CURRENT_TIMESTAMP,
  usuario_id integer not null,
  tipo text not null,
  valor numeric not null,
  descricao text not null,
  categoria_id integer not null,
  data_prevista date not null,
  data_efetivacao date null,
  recorrente boolean not null default false,
  periodicidade text null,
  status text not null default 'pendente'::text,
  pagador_recebedor text null,
  ultima_atualizacao timestamp with time zone null default now(),
  mes_previsto text null,
  parcelamento text null default 'false'::text,
  numero_parcelas integer null,
  parcela_atual integer null,
  transacao_id integer null,
  data_final date null,
  confirmed_dates text null,
  dependente_id integer null,
  tipo_conta text null default 'pessoal'::text,
  conta_id uuid null,
  cartao_id uuid null,
  parcela_info jsonb null,
  constraint lancamentos_futuros_pkey primary key (id),
  constraint lancamentos_futuros_categoria_id_fkey foreign KEY (categoria_id) references categoria_trasacoes (id) on delete RESTRICT,
  constraint lancamentos_futuros_transacao_id_fkey foreign KEY (transacao_id) references transacoes (id) on delete set null,
  constraint lancamentos_futuros_dependente_id_fkey foreign KEY (dependente_id) references usuarios_dependentes (id) on delete set null,
  constraint lancamentos_futuros_cartao_id_fkey foreign KEY (cartao_id) references cartoes_credito (id) on delete set null,
  constraint lancamentos_futuros_conta_id_fkey foreign KEY (conta_id) references contas_bancarias (id) on delete set null,
  constraint lancamentos_futuros_usuario_id_fkey foreign KEY (usuario_id) references usuarios (id) on delete CASCADE,
  constraint lancamentos_futuros_valor_positivo check ((valor > (0)::numeric)),
  constraint lancamentos_futuros_periodicidade_check check (
    (
      (periodicidade is null)
      or (periodicidade = ''::text)
      or (
        periodicidade = any (
          array[
            'diario'::text,
            'semanal'::text,
            'quinzenal'::text,
            'mensal'::text,
            'bimestral'::text,
            'trimestral'::text,
            'semestral'::text,
            'anual'::text
          ]
        )
      )
    )
  ),
  constraint lancamentos_futuros_status_check check (
    (
      status = any (
        array['pendente'::text, 'pago'::text, 'cancelado'::text]
      )
    )
  ),
  constraint lancamentos_futuros_tipo_check check (
    (
      tipo = any (array['entrada'::text, 'saida'::text])
    )
  ),
  constraint lancamentos_futuros_tipo_conta_check check (
    (
      tipo_conta = any (array['pessoal'::text, 'pj'::text])
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_futuros_expansion_query on public.lancamentos_futuros using btree (
  usuario_id,
  recorrente,
  status,
  data_prevista,
  data_final
) TABLESPACE pg_default
where
  (
    (recorrente = true)
    and (status = 'pendente'::text)
    and (data_final is not null)
  );

create index IF not exists lancamentos_futuros_mes_previsto_idx on public.lancamentos_futuros using btree (mes_previsto) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_futuros_data_final on public.lancamentos_futuros using btree (data_final) TABLESPACE pg_default
where
  (data_final is not null);

create index IF not exists idx_lancamentos_futuros_recorrente_periodo on public.lancamentos_futuros using btree (recorrente, data_prevista, status) TABLESPACE pg_default
where
  (
    (recorrente = true)
    and (status = 'pendente'::text)
  );

create index IF not exists idx_lancamentos_futuros_dependente on public.lancamentos_futuros using btree (dependente_id) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_futuros_categoria_id on public.lancamentos_futuros using btree (categoria_id) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_futuros_transacao_id on public.lancamentos_futuros using btree (transacao_id) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_futuros_status on public.lancamentos_futuros using btree (status) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_futuros_tipo_conta on public.lancamentos_futuros using btree (tipo_conta) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_futuros_usuario_conta on public.lancamentos_futuros using btree (usuario_id, tipo_conta) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_futuros_data_prevista on public.lancamentos_futuros using btree (data_prevista) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_futuros_tipo on public.lancamentos_futuros using btree (tipo) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_futuros_usuario_conta_data on public.lancamentos_futuros using btree (usuario_id, tipo_conta, data_prevista) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_futuros_conta_id on public.lancamentos_futuros using btree (conta_id) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_cartao on public.lancamentos_futuros using btree (cartao_id) TABLESPACE pg_default;

create index IF not exists idx_lancamentos_futuros_usuario_status on public.lancamentos_futuros using btree (usuario_id, status) TABLESPACE pg_default;

create trigger trigger_auto_fill_usuario_id_lancamentos BEFORE INSERT on lancamentos_futuros for EACH row
execute FUNCTION auto_fill_usuario_id_lancamentos (); , 

create table public.metas_orcamento (
  id integer generated by default as identity not null,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  usuario_id integer not null,
  nome text not null,
  tipo_meta text not null,
  valor_limite numeric not null,
  categoria_id integer null,
  data_inicio date not null,
  data_fim date not null,
  tipo_periodo text not null,
  ativo boolean null default true,
  alerta_70_porcento boolean null default true,
  alerta_80_porcento boolean null default true,
  alerta_90_porcento boolean null default true,
  alerta_100_porcento boolean null default true,
  tipo_conta text not null default 'pessoal'::text,
  constraint metas_orcamento_pkey primary key (id),
  constraint metas_orcamento_usuario_id_fkey foreign KEY (usuario_id) references usuarios (id) on delete CASCADE,
  constraint metas_orcamento_categoria_id_fkey foreign KEY (categoria_id) references categoria_trasacoes (id) on delete CASCADE,
  constraint metas_orcamento_tipo_meta_check check (
    (
      tipo_meta = any (
        array[
          'categoria'::text,
          'geral'::text,
          'economia'::text,
          'geral_entrada'::text,
          'geral_saida'::text
        ]
      )
    )
  ),
  constraint metas_orcamento_tipo_periodo_check check (
    (
      tipo_periodo = any (
        array[
          'mensal'::text,
          'semanal'::text,
          'diario'::text,
          'personalizado'::text,
          'anual'::text
        ]
      )
    )
  ),
  constraint metas_orcamento_valor_limite_check check ((valor_limite > (0)::numeric)),
  constraint metas_orcamento_data_check check ((data_fim >= data_inicio)),
  constraint metas_orcamento_tipo_conta_check check (
    (
      tipo_conta = any (array['pessoal'::text, 'pj'::text])
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_metas_orcamento_usuario_id on public.metas_orcamento using btree (usuario_id) TABLESPACE pg_default;

create index IF not exists idx_metas_orcamento_ativo on public.metas_orcamento using btree (ativo) TABLESPACE pg_default;

create index IF not exists idx_metas_orcamento_periodo on public.metas_orcamento using btree (data_inicio, data_fim) TABLESPACE pg_default;

create index IF not exists idx_metas_orcamento_categoria_id on public.metas_orcamento using btree (categoria_id) TABLESPACE pg_default;

create index IF not exists idx_metas_orcamento_tipo_meta on public.metas_orcamento using btree (tipo_meta) TABLESPACE pg_default;, 

create table public.n8n_chat_histories_corporation (
  id integer generated by default as identity not null,
  session_id character varying not null,
  message jsonb not null,
  constraint n8n_chat_histories_corporation_pkey primary key (id)
) TABLESPACE pg_default; , 

create table public.planos_sistema (
  id integer generated by default as identity not null,
  nome character varying(100) not null,
  tipo_periodo character varying(20) not null,
  valor numeric(10, 2) not null,
  link_checkout text not null,
  ativo boolean null default true,
  ordem_exibicao integer null default 1,
  descricao text null,
  recursos jsonb null default '[]'::jsonb,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  permite_compartilhamento boolean null default false,
  max_usuarios_dependentes integer null default 0,
  destaque boolean null default false,
  permite_modo_pj boolean null default true,
  permite_investimentos boolean null default false,
  max_ativos_investimento integer null default 0,
  constraint planos_sistema_pkey primary key (id),
  constraint planos_sistema_nome_unique unique (nome),
  constraint planos_sistema_max_usuarios_dependentes_check check ((max_usuarios_dependentes >= 0)),
  constraint planos_sistema_ordem_exibicao_check check ((ordem_exibicao > 0)),
  constraint planos_sistema_tipo_periodo_check check (
    (
      (tipo_periodo)::text = any (
        (
          array[
            'mensal'::character varying,
            'trimestral'::character varying,
            'semestral'::character varying,
            'anual'::character varying,
            'free'::character varying
          ]
        )::text[]
      )
    )
  ),
  constraint planos_sistema_valor_check check ((valor >= (0)::numeric))
) TABLESPACE pg_default;

create index IF not exists idx_planos_sistema_ativo_ordem on public.planos_sistema using btree (ativo, ordem_exibicao) TABLESPACE pg_default;

create index IF not exists idx_planos_compartilhamento on public.planos_sistema using btree (permite_compartilhamento) TABLESPACE pg_default
where
  (permite_compartilhamento = true); , 

  create table public.preferencias_notificacao (
  id bigint generated by default as identity not null,
  usuario_id integer not null,
  tipo_notificacao text not null,
  habilitado boolean not null default true,
  dias_antecedencia integer null default 1,
  created_at timestamp with time zone not null default timezone ('utc'::text, now()),
  updated_at timestamp with time zone not null default timezone ('utc'::text, now()),
  constraint preferencias_notificacao_pkey primary key (id),
  constraint preferencias_notificacao_usuario_tipo_key unique (usuario_id, tipo_notificacao),
  constraint preferencias_notificacao_usuario_id_fkey foreign KEY (usuario_id) references usuarios (id) on delete CASCADE,
  constraint preferencias_notificacao_dias_antecedencia_check check ((dias_antecedencia >= 0)),
  constraint preferencias_notificacao_tipo_notificacao_check check (
    (
      tipo_notificacao = any (
        array[
          'lembrete_vencimento'::text,
          'relatorio_mensal'::text,
          'email_geral'::text
        ]
      )
    )
  )
) TABLESPACE pg_default;

create trigger on_preferencias_notificacao_updated BEFORE
update on preferencias_notificacao for EACH row
execute FUNCTION handle_updated_at (); , 

create table public.solicitacoes_lgpd (
  id integer generated by default as identity not null,
  usuario_id integer not null,
  tipo_solicitacao text not null,
  status text not null default 'pendente'::text,
  data_solicitacao timestamp with time zone null default now(),
  data_conclusao timestamp with time zone null,
  justificativa text null,
  constraint solicitacoes_lgpd_pkey primary key (id),
  constraint solicitacoes_lgpd_usuario_id_fkey foreign KEY (usuario_id) references usuarios (id) on delete CASCADE,
  constraint solicitacoes_lgpd_status_check check (
    (
      status = any (
        array[
          'pendente'::text,
          'processando'::text,
          'concluido'::text,
          'negado'::text
        ]
      )
    )
  ),
  constraint solicitacoes_lgpd_tipo_solicitacao_check check (
    (
      tipo_solicitacao = any (
        array[
          'exclusao'::text,
          'acesso'::text,
          'retificacao'::text
        ]
      )
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_solicitacoes_lgpd_usuario_id on public.solicitacoes_lgpd using btree (usuario_id) TABLESPACE pg_default; , 

create table public.transacoes (
  id integer generated by default as identity not null,
  created_at timestamp without time zone null default CURRENT_TIMESTAMP,
  data date not null,
  valor numeric not null,
  descricao text not null,
  recebedor text null,
  mes text not null,
  categoria_id integer not null,
  tipo text not null,
  usuario_id integer not null,
  pagador text null,
  lancamento_futuro_id integer null,
  dependente_id integer null,
  tipo_conta text null default 'pessoal'::text,
  conta_id uuid null,
  cartao_id uuid null,
  is_transferencia boolean null default false,
  conta_destino_id uuid null,
  constraint transacoes_pkey primary key (id),
  constraint transacoes_categoria_id_fkey foreign KEY (categoria_id) references categoria_trasacoes (id) on delete RESTRICT,
  constraint transacoes_conta_destino_id_fkey foreign KEY (conta_destino_id) references contas_bancarias (id) on delete set null,
  constraint transacoes_conta_id_fkey foreign KEY (conta_id) references contas_bancarias (id) on delete set null,
  constraint transacoes_dependente_id_fkey foreign KEY (dependente_id) references usuarios_dependentes (id) on delete set null,
  constraint transacoes_lancamento_futuro_id_fkey foreign KEY (lancamento_futuro_id) references lancamentos_futuros (id) on delete set null,
  constraint transacoes_cartao_id_fkey foreign KEY (cartao_id) references cartoes_credito (id) on delete set null,
  constraint transacoes_usuario_id_fkey foreign KEY (usuario_id) references usuarios (id) on delete CASCADE,
  constraint transacoes_tipo_conta_check check (
    (
      tipo_conta = any (array['pessoal'::text, 'pj'::text])
    )
  ),
  constraint transacoes_valor_positivo check ((valor > (0)::numeric)),
  constraint transacoes_tipo_check check (
    (
      tipo = any (array['entrada'::text, 'saida'::text])
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_transacoes_dependente on public.transacoes using btree (dependente_id) TABLESPACE pg_default;

create index IF not exists idx_transacoes_categoria_id on public.transacoes using btree (categoria_id) TABLESPACE pg_default;

create index IF not exists idx_transacoes_lancamento_futuro_id on public.transacoes using btree (lancamento_futuro_id) TABLESPACE pg_default;

create index IF not exists idx_transacoes_usuario_id on public.transacoes using btree (usuario_id) TABLESPACE pg_default;

create index IF not exists idx_transacoes_data on public.transacoes using btree (data) TABLESPACE pg_default;

create index IF not exists idx_transacoes_tipo on public.transacoes using btree (tipo) TABLESPACE pg_default;

create index IF not exists idx_transacoes_tipo_conta on public.transacoes using btree (tipo_conta) TABLESPACE pg_default;

create index IF not exists idx_transacoes_usuario_conta on public.transacoes using btree (usuario_id, tipo_conta) TABLESPACE pg_default;

create index IF not exists idx_transacoes_usuario_conta_data on public.transacoes using btree (usuario_id, tipo_conta, data) TABLESPACE pg_default;

create index IF not exists idx_transacoes_conta_id on public.transacoes using btree (conta_id) TABLESPACE pg_default;

create index IF not exists idx_transacoes_cartao on public.transacoes using btree (cartao_id) TABLESPACE pg_default;

create index IF not exists idx_transacoes_usuario_data on public.transacoes using btree (usuario_id, data) TABLESPACE pg_default;

create index IF not exists idx_transacoes_is_transferencia on public.transacoes using btree (is_transferencia) TABLESPACE pg_default;

create index IF not exists idx_transacoes_conta_destino on public.transacoes using btree (conta_destino_id) TABLESPACE pg_default;

create trigger trigger_atualizar_saldo_conta
after INSERT
or DELETE on transacoes for EACH row
execute FUNCTION atualizar_saldo_conta ();

create trigger trigger_update_balance
after INSERT
or DELETE
or
update on transacoes for EACH row
execute FUNCTION update_account_balance (); , 

create table public.usuarios (
  id integer generated by default as identity not null,
  created_at timestamp without time zone null default CURRENT_TIMESTAMP,
  nome text not null,
  email text not null,
  celular text not null,
  aceite_termos boolean null default false,
  data_aceite_termos timestamp with time zone null,
  ultima_atualizacao timestamp with time zone null default now(),
  status text null default 'ativo'::text,
  plano text null,
  data_compra timestamp with time zone null,
  data_final_plano timestamp with time zone null,
  has_password boolean null default false,
  auth_user uuid null,
  is_admin boolean null default false,
  data_ultimo_acesso timestamp with time zone null default now(),
  dias_restantes_free integer null,
  plano_id integer null,
  data_ultima_mensagem timestamp with time zone null,
  lid_original character varying(255) null,
  idioma text null default 'pt'::text,
  moeda text null default 'BRL'::text,
  constraint usuarios_pkey primary key (id),
  constraint usuarios_email_key unique (email),
  constraint usuarios_plano_id_fkey foreign KEY (plano_id) references planos_sistema (id) on delete set null,
  constraint usuarios_auth_user_fkey foreign KEY (auth_user) references auth.users (id) on delete set null,
  constraint usuarios_moeda_check check (
    (
      moeda = any (
        array[
          'BRL'::text,
          'USD'::text,
          'EUR'::text,
          'PYG'::text,
          'ARS'::text
        ]
      )
    )
  ),
  constraint usuarios_idioma_check check (
    (
      idioma = any (array['pt'::text, 'es'::text, 'en'::text])
    )
  ),
  constraint usuarios_status_check check (
    (
      status = any (
        array[
          'ativo'::text,
          'inativo'::text,
          'bloqueado'::text,
          'excluido'::text
        ]
      )
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_usuarios_is_admin on public.usuarios using btree (is_admin) TABLESPACE pg_default;

create index IF not exists idx_usuarios_data_ultimo_acesso on public.usuarios using btree (data_ultimo_acesso) TABLESPACE pg_default;

create index IF not exists idx_usuarios_plano_id on public.usuarios using btree (plano_id) TABLESPACE pg_default;

create index IF not exists idx_usuarios_created_at on public.usuarios using btree (created_at) TABLESPACE pg_default;

create index IF not exists idx_usuarios_auth_user on public.usuarios using btree (auth_user) TABLESPACE pg_default;

create index IF not exists idx_usuarios_status on public.usuarios using btree (status) TABLESPACE pg_default;

create trigger on_public_user_created_link_invite
after INSERT on usuarios for EACH row
execute FUNCTION handle_public_user_invite_link ();

create trigger prevent_duplicate_user_trigger BEFORE INSERT on usuarios for EACH row
execute FUNCTION prevent_duplicate_user_on_signup ();

create trigger set_plano_id_on_user BEFORE INSERT
or
update on usuarios for EACH row
execute FUNCTION auto_set_plano_id (); , 

create table public.usuarios_dependentes (
  id serial not null,
  nome text not null,
  email text null,
  telefone text null,
  usuario_principal_id integer not null,
  status text null default 'ativo'::text,
  data_criacao timestamp with time zone null default now(),
  data_ultima_modificacao timestamp with time zone null default now(),
  observacoes text null,
  auth_user_id uuid null,
  convite_status text null default 'pendente'::text,
  convite_enviado_em timestamp with time zone null default now(),
  avatar_url text null,
  permissoes jsonb null default '{"nivel_acesso": "basico", "pode_ver_relatorios": true, "pode_ver_dados_admin": true, "pode_convidar_membros": false, "pode_criar_transacoes": true, "pode_gerenciar_contas": false, "pode_editar_transacoes": true, "pode_gerenciar_cartoes": false, "pode_deletar_transacoes": false, "pode_ver_outros_membros": false}'::jsonb,
  constraint usuarios_dependentes_pkey primary key (id),
  constraint usuarios_dependentes_auth_user_id_fkey foreign KEY (auth_user_id) references auth.users (id),
  constraint usuarios_dependentes_usuario_principal_id_fkey foreign KEY (usuario_principal_id) references usuarios (id) on delete CASCADE,
  constraint usuarios_dependentes_convite_status_check check (
    (
      convite_status = any (
        array[
          'pendente'::text,
          'aceito'::text,
          'recusado'::text,
          'cancelado'::text
        ]
      )
    )
  ),
  constraint usuarios_dependentes_status_check check (
    (
      status = any (array['ativo'::text, 'inativo'::text])
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_usuarios_dependentes_principal on public.usuarios_dependentes using btree (usuario_principal_id) TABLESPACE pg_default;

create index IF not exists idx_usuarios_dependentes_status on public.usuarios_dependentes using btree (usuario_principal_id, status) TABLESPACE pg_default
where
  (status = 'ativo'::text);

create index IF not exists idx_usuarios_dependentes_nome on public.usuarios_dependentes using btree (nome) TABLESPACE pg_default;

create index IF not exists idx_usuarios_dependentes_auth_user on public.usuarios_dependentes using btree (auth_user_id) TABLESPACE pg_default;

create index IF not exists idx_usuarios_dependentes_email on public.usuarios_dependentes using btree (email) TABLESPACE pg_default;

create index IF not exists idx_usuarios_dependentes_permissoes on public.usuarios_dependentes using gin (permissoes) TABLESPACE pg_default;

create trigger trigger_auto_fill_usuario_principal_id BEFORE INSERT on usuarios_dependentes for EACH row
execute FUNCTION auto_fill_usuario_principal_id (); 